<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cudio Media</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <style>
      /* Adjust player layout for desktop */
      .player-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
        width: 100%;
      }

      .player-info {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .controls {
        display: flex;
        gap: 16px;
        justify-content: center;
      }

      .progress-container {
        width: 100%;
        margin-top: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        height: 8px;
        position: relative;
        overflow: hidden;
      }

      .waveform-bg {
        background: repeating-linear-gradient(
          90deg,
          #0f9d58,
          #0f9d58 2px,
          transparent 2px,
          transparent 4px
        );
        height: 100%;
      }

      .progress-bar {
        height: 100%;
        background: rgba(255, 255, 255, 0.3);
        width: 0%;
      }

      .volume-control {
        flex: 0 0 auto;
      }

      @media (max-width: 600px) {
        .player-flex {
          flex-direction: column;
          align-items: stretch;
        }

        .search-bar {
          flex-direction: column;
          align-items: stretch;
        }

        .search-bar input {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">Cudio Media ðŸŽµ</h1>
      <div class="search-bar">
        <input
          type="text"
          id="searchInput"
          placeholder="Search for music..."
          onkeydown="if(event.key === 'Enter') searchMusic()"
        />
        <button onclick="searchMusic()" class="material-button">
          <span class="material-symbols-outlined">search</span>
        </button>
      </div>
      <div id="results"></div>
    </div>

    <div id="player" class="hidden">
      <div id="ytplayer" style="display: none"></div>

      <div class="player-container enhanced">
        <div class="player-flex">
          <div class="player-info">
            <img id="player-cover" src="" alt="Cover" />
            <div>
              <h3 id="player-title">Title</h3>
              <p id="player-artist">Artist</p>
            </div>
          </div>

          <div class="controls">
            <button onclick="playVideo()" class="material-button">
              <span class="material-symbols-outlined">play_arrow</span>
            </button>
            <button onclick="pauseVideo()" class="material-button">
              <span class="material-symbols-outlined">pause</span>
            </button>
            <button onclick="stopVideo()" class="material-button">
              <span class="material-symbols-outlined">stop</span>
            </button>
          </div>

          <div class="volume-control">
            <input
              type="range"
              min="0"
              max="100"
              value="100"
              id="volumeSlider"
              onchange="setVolume(this.value)"
            />
          </div>
        </div>

        <div class="progress-container" onclick="seek(event)">
          <div class="waveform-bg">
            <div class="progress-bar" id="progressBar"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let player;
      let progressInterval;

      function onYouTubeIframeAPIReady() {
        player = new YT.Player("ytplayer", {
          height: "0",
          width: "0",
          videoId: "",
          playerVars: { autoplay: 1 },
          events: {
            onReady: () => updateProgressBar(),
          },
        });
      }

      function searchMusic() {
        const query = document.getElementById("searchInput").value;
        fetch("https://cudio-back.onrender.com/search", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ query }),
          mode: "cors",
        })
          .then((res) => {
            if (!res.ok) throw new Error("Network response was not ok");
            return res.json();
          })
          .then((data) => {
            const results = document.getElementById("results");
            results.innerHTML = "";
            data.forEach((song) => {
              const div = document.createElement("div");
              div.classList.add("song");
              div.innerHTML = `
                <img src="${song.thumbnail}" />
                <div class="info">
                  <h3>${song.title}</h3>
                  <p>${song.artists}</p>
                </div>
                <button class="material-button" onclick="loadVideo('${song.videoId}')">
                  <span class="material-symbols-outlined">play_arrow</span>
                </button>
              `;
              results.appendChild(div);
            });
          })
          .catch((error) => {
            console.error("Error fetching search results:", error);
            alert("Failed to fetch search results. Please try again later.");
          });
      }

      function loadVideo(videoId) {
        if (player && typeof player.loadVideoById === "function") {
          player.loadVideoById(videoId);
        } else {
          player = new YT.Player("ytplayer", {
            height: "0",
            width: "0",
            videoId: videoId,
            events: {
              onReady: () => updateProgressBar(),
            },
          });
        }

        const selectedSong = [...document.querySelectorAll(".song button")]
          .find((btn) => btn.getAttribute("onclick").includes(videoId))
          ?.closest(".song");

        if (selectedSong) {
          document.getElementById("player-cover").src =
            selectedSong.querySelector("img").src;
          document.getElementById("player-title").textContent =
            selectedSong.querySelector("h3").textContent;
          document.getElementById("player-artist").textContent =
            selectedSong.querySelector("p").textContent;
        }

        document.getElementById("player").classList.remove("hidden");
        updateProgressBar();
      }

      function playVideo() {
        if (player) player.playVideo();
      }

      function pauseVideo() {
        if (player) player.pauseVideo();
      }

      function stopVideo() {
        if (player) {
          player.stopVideo();
          clearInterval(progressInterval);
          document.getElementById("progressBar").style.width = "0%";
        }
      }

      function updateProgressBar() {
        clearInterval(progressInterval);
        progressInterval = setInterval(() => {
          if (player && player.getDuration && player.getCurrentTime) {
            const duration = player.getDuration();
            const currentTime = player.getCurrentTime();
            const progress = (currentTime / duration) * 100;
            document.getElementById("progressBar").style.width = `${progress}%`;
          }
        }, 500);
      }

      function seek(event) {
        const container = event.currentTarget;
        const rect = container.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const percent = x / rect.width;
        const duration = player.getDuration();
        player.seekTo(duration * percent, true);
      }

      function setVolume(value) {
        if (player && typeof player.setVolume === "function") {
          player.setVolume(parseInt(value));
        }
      }

      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      document.body.appendChild(tag);
    </script>
  </body>
</html>

