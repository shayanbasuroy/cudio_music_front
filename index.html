<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cudio Media</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background: #e0e0e0;
        margin: 0;
        padding: 0;
        color: #222;
      }

      .container {
        max-width: 600px;
        margin: auto;
        padding: 20px;
      }

      .title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        text-align: center;
        color: rgb(0, 0, 0);
      }

      .search-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
      }

      .search-bar input {
        flex: 1;
        padding: 10px 12px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .material-search {
        background: #5d0bd9;
        color: white;
        border: none;
        padding: 0 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .material-search:hover {
        background: #5d0bd9;
      }

      .material-button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 28px;
        color: #5d0bd9;
        padding: 8px;
        transition: color 0.2s ease;
      }

      .material-button:hover {
        color: #5d0bd9;
      }

      .hidden {
        display: none;
      }

      .player-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
        width: 100%;
      }

      .player-info {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .controls {
        display: flex;
        gap: 16px;
        justify-content: center;
      }

      .progress-container {
        width: 100%;
        margin-top: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        height: 8px;
        position: relative;
        overflow: hidden;
        cursor: pointer;
      }

      .waveform-bg {
        background: repeating-linear-gradient(
          90deg,
          #5d0bd9,
          #5d0bd9 2px,
          transparent 2px,
          transparent 4px
        );
        height: 100%;
      }

      .progress-bar {
        height: 100%;
        background: rgba(255, 255, 255, 0.3);
        width: 0%;
        transition: width 0.3s ease;
      }

      .volume-control {
        flex: 0 0 auto;
      }

      @media (max-width: 600px) {
        .player-flex {
          flex-direction: column;
          align-items: stretch;
        }

        .search-bar {
          flex-direction: row;
          align-items: center;
        }

        .search-bar input {
          width: auto;
          flex: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">Cudio Media ðŸŽµ</h1>

      <div class="search-bar">
        <input
          type="text"
          id="searchInput"
          placeholder="Search for music..."
          onkeydown="if(event.key === 'Enter') searchMusic()"
          autocomplete="off"
        />
        <button onclick="searchMusic()" class="material-search" title="Search">
          <span class="material-symbols-outlined">search</span>
        </button>
      </div>

      <div id="results"></div>

      <div id="player" class="hidden" style="margin-top: 20px">
        <div id="ytplayer" style="display: none"></div>

        <div class="player-container">
          <div class="player-flex">
            <div class="player-info">
              <img
                id="player-cover"
                src=""
                alt="Cover"
                style="
                  width: 60px;
                  height: 60px;
                  object-fit: cover;
                  border-radius: 6px;
                "
              />
              <div>
                <h3 id="player-title" style="margin: 0; font-size: 18px">
                  Title
                </h3>
                <p
                  id="player-artist"
                  style="margin: 0; font-size: 14px; color: #fff"
                >
                  Artist
                </p>
              </div>
            </div>

            <div class="controls">
              <button
                onclick="togglePlayPause()"
                class="material-button"
                id="playPauseBtn"
                title="Play/Pause"
              >
                <span class="material-symbols-outlined" id="playPauseIcon"
                  >play_arrow</span
                >
              </button>
            </div>

            <div class="volume-control">
              <input
                type="range"
                min="0"
                max="100"
                value="100"
                id="volumeSlider"
                onchange="setVolume(this.value)"
                title="Volume"
              />
            </div>
          </div>

          <div class="progress-container" onclick="seek(event)" title="Seek">
            <div class="waveform-bg">
              <div class="progress-bar" id="progressBar"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let player;
      let progressInterval;
      let playerReady = false;
      let queuedVideoId = null;

      const playPauseIcon = document.getElementById("playPauseIcon");

      function onYouTubeIframeAPIReady() {
        player = new YT.Player("ytplayer", {
          height: "0",
          width: "0",
          videoId: "",
          playerVars: { autoplay: 0 },
          events: {
            onReady: () => {
              playerReady = true;
              updateProgressBar();
              if (queuedVideoId) {
                loadAndPlayVideo(queuedVideoId);
                queuedVideoId = null;
              }
            },
            onStateChange: (event) => {
              if (event.data === YT.PlayerState.ENDED) {
                playPauseIcon.textContent = "play_arrow";
              } else if (event.data === YT.PlayerState.PLAYING) {
                playPauseIcon.textContent = "pause";
              } else if (event.data === YT.PlayerState.PAUSED) {
                playPauseIcon.textContent = "play_arrow";
              }
            },
          },
        });
      }

      function searchMusic() {
        const query = document.getElementById("searchInput").value.trim();
        if (!query) return;

        const cached = localStorage.getItem("search_" + query.toLowerCase());
        if (cached) {
          showResults(JSON.parse(cached));
          return;
        }

        fetch("https://cudio-back.onrender.com/search", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ query }),
          mode: "cors",
        })
          .then((res) => res.json())
          .then((data) => {
            localStorage.setItem(
              "search_" + query.toLowerCase(),
              JSON.stringify(data)
            );
            showResults(data);
          })
          .catch((error) => {
            console.error("Error fetching search results:", error);
            alert("Failed to fetch search results. Please try again later.");
          });
      }

      function showResults(data) {
        const results = document.getElementById("results");
        results.innerHTML = "";
        if (data.length === 0) {
          results.innerHTML = "<p>No results found.</p>";
          return;
        }
        data.forEach((song) => {
          const div = document.createElement("div");
          div.classList.add("song");
          div.style.display = "flex";
          div.style.alignItems = "center";
          div.style.gap = "12px";
          div.style.marginBottom = "12px";
          div.innerHTML = `
            <img src="${song.thumbnail}" alt="${song.title}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" />
            <div class="info" style="flex: 1;">
              <h3 style="margin: 0; font-size: 16px;">${song.title}</h3>
              <p style="margin: 0; font-size: 14px; color: #666;">${song.artists}</p>
            </div>
            <button class="material-button" onclick="loadVideo('${song.videoId}')" title="Play">
              <span class="material-symbols-outlined">play_arrow</span>
            </button>
          `;
          results.appendChild(div);
        });
      }

      function loadAndPlayVideo(videoId) {
        if (!playerReady) {
          queuedVideoId = videoId;
          return;
        }
        player.loadVideoById(videoId);
        player.playVideo();
        playPauseIcon.textContent = "pause";
        updateProgressBar();
      }

      function loadVideo(videoId) {
        loadAndPlayVideo(videoId);
        const selectedSong = [...document.querySelectorAll(".song button")]
          .find((btn) => btn.getAttribute("onclick").includes(videoId))
          ?.closest(".song");

        if (selectedSong) {
          document.getElementById("player-cover").src =
            selectedSong.querySelector("img").src;
          document.getElementById("player-title").textContent =
            selectedSong.querySelector("h3").textContent;
          document.getElementById("player-artist").textContent =
            selectedSong.querySelector("p").textContent;
        }

        document.getElementById("player").classList.remove("hidden");
      }

      function togglePlayPause() {
        if (!playerReady) return;

        const state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
          player.pauseVideo();
        } else {
          player.playVideo();
        }
      }

      function setVolume(value) {
        if (playerReady) {
          player.setVolume(value);
        }
      }

      function updateProgressBar() {
        clearInterval(progressInterval);
        progressInterval = setInterval(() => {
          if (player && player.getDuration && player.getCurrentTime) {
            const duration = player.getDuration();
            const currentTime = player.getCurrentTime();
            if (duration > 0) {
              const percentage = (currentTime / duration) * 100;
              document.getElementById(
                "progressBar"
              ).style.width = `${percentage}%`;
            }
          }
        }, 500);
      }

      function seek(event) {
        if (!playerReady) return;

        const container = event.currentTarget;
        const rect = container.getBoundingClientRect();
        const offsetX = event.clientX - rect.left;
        const percentage = offsetX / rect.width;
        const duration = player.getDuration();
        player.seekTo(duration * percentage, true);
      }
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
  </body>
</html>
